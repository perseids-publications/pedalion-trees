/*
 * Arethusa - a backend-independent client-side annotation framework
 * http://github.com/alpheios-project/arethusa
 *
 * Version 0.2.5
 * built from branch HEAD
 * at 952ce617456676bbbac7a486b01b148463e8d959
 * on 2020-05-13T12:28:02.105Z
 *
 * Published under the MIT license
 */

"use strict";angular.module("arethusa.relation",[]),angular.module("arethusa.relation").directive("labelSelector",["relation","$timeout",function(a,b){return{restrict:"A",scope:{obj:"=",change:"&"},link:function(c,d,e){c.plugin=a,c.showMenu=!0,c.$watch("plugin.mode",function(b,d){c.showMenu=a.canEdit()}),c.$on("nestedMenuSelection",function(d,f){if(e.change&&angular.isFunction(c.change))c.change();else{var g=angular.copy(f.ancestors);b(function(){a.changeState(f,g)})}})},templateUrl:"js/arethusa.relation/templates/label_selector.html"}}]),angular.module("arethusa.relation").directive("nestedMenu",["$compile","$timeout","$window","saver","navigator",function(a,b,c,d,e){return{restrict:"A",scope:{relObj:"=",labelObj:"=",label:"=",labelAs:"=",property:"=",ancestors:"="},link:function(f,g,h){function i(){angular.isFunction(f.relObj.markChange)&&f.relObj.markChange()}var j='          <ul            nested-menu-collection            current="relObj"            property="property"            ancestors="ancestors"            label-as="labelAs"            all="labelObj.nested">          </ul>        ',k=angular.element(c);f.labelRepresentation=f.label?f.label:"---";var l=f.labelObj.nested;l&&(g.addClass("nested"),g.bind("mouseenter",function(){var b=a(j)(f),c=k.height()-10,d=Object.keys(l).length,e=d*g.height(),h=g.offset().top;if(h+e>c){var i=c-h,m=e-i;b.css("top","-"+m+"px")}g.append(b),g.unbind("mouseenter")})),f.selectLabel=function(){f.property&&(f.relObj[f.property]=f.label,f.$emit("nestedMenuSelection",f.relObj))},f.addAncestor=function(a,b){a.ancestors.unshift(b)},f.resetAncestors=function(a){for(var b=a.ancestors;b.length>0;)b.pop()},g.bind("click",function(a){f.$apply(function(){e.markChunkChanged(),d.needsSave=!0,2===a.eventPhase&&(i(),f.selectLabel(),f.ancestors&&f.resetAncestors(f.relObj)),f.ancestors&&f.addAncestor(f.relObj,f.labelObj)})});var m=angular.element(document.getElementById("sidepanel"));f.labelObj.nested&&g.on("mouseenter",function(){b(function(){if(g.is(":hover")){var a=m[0],b=m.width(),c=g.scrollLeft(),d=a.scrollWidth-c-b;d>0&&m.scrollLeft(c+d,500)}},500)})},template:"{{ labelRepresentation }}"}}]),angular.module("arethusa.relation").directive("nestedMenuCollection",["$window",function(a){return{restrict:"A",replace:"true",scope:{current:"=",all:"=",property:"=",ancestors:"=",emptyVal:"@",labelAs:"="},link:function(b,c,d){var e=angular.element(a);if(b.emptyLabel="",b.emptyObj={},b.labelView=function(a){return b.labelAs?a[b.labelAs]:a.short},c.hasClass("top-menu")){var f=Object.keys(b.all||{}).length+1;if(f<15){var g=18*f,h=e.height()-15;c.parent().offset().top+g>h&&c.css({top:"auto",bottom:"100%"})}}},template:'        <ul>          <li ng-if="emptyVal"            nested-menu            property="property"            rel-obj="current"            ancestors="ancestors"            label="emptyLabel"            label-obj="emptyObj">          </li>          <li            ng-repeat="label in all | keys"            nested-menu            property="property"            rel-obj="current"            ancestors="ancestors"            label="labelView(all[label])"            label-as="labelAs"            label-obj="all[label]">          </li>        </ul>      '}}]),angular.module("arethusa.relation").directive("relationMultiChanger",["relation",function(a){return{restrict:"A",link:function(b,c,d){b.isPossible=a.multiChangePossible,b.apply=a.applyMultiChanger,b.r=a,b.$watch("r.mode",function(b,d){a.canEdit()?c.show():c.hide()})},templateUrl:"js/arethusa.relation/templates/relation_multi_changer.html"}}]),angular.module("arethusa.relation").directive("syntacticalDescription",["$compile","state","relation","_",function(a,b,c,d){function e(a){return['<span ng-style="{{ content.'+a+'.style }}">',"{{ content."+a+".label}}","</span>"].join("")}function f(a){return['<span ng-if=" content.'+a+'.token"','token="content.'+a+'.token"','class="syntax-token"','click="true"','hover="true">',"</span>",'<span ng-if="!content.'+a+' .token"','class="syntax-token">',"{{ content."+a+".string}}","</span>"].join(" ")}function g(a){var b=[a.left,a.right].join("-");return h[b]}var h={"1-0":["<div>",f("target"),"is {{ content.target.article}}",e("target")+".","</div>"].join(" "),"1-1":["<div>",f("target"),"is {{ content.target.article}}",e("target"),"of the",e("head"),f("head")+".","</div>"].join(" ")};return{restrict:"EA",scope:{tokenId:"="},link:function(e,f,h){function i(a){u(),E.token=n(a),F.head=o(E.token),r(),z()}function j(a,b,c){m(c.token.id)&&i(e.tokenId)}function k(a){H.push(b.watch(a,j))}function l(){for(;H.length;)H.pop()()}function m(a){return d.contains(G,a)}function n(a){if(a)return p(a),b.getToken(a);q(a)}function o(a){var c;return a&&(c=aU.getProperty(a,"head.id")),c?b.getToken(c):void 0}function p(a){m(a)||G.push(a)}function q(a){var b=G.indexOf(a);b&&G.splice(b,1)}function r(){E.token&&s(),F.head&&t()}function s(){D.left+=1}function t(){D.right+=1}function u(){w(),v(),x()}function v(){D={left:0,right:0}}function w(){E={},F={}}function x(){e.content={}}function y(a,b){b&&(e.content[a]=b)}function z(){f.empty();var b=g(D);if(b){y("target",B(E.token)),y("head",B(F.head));var c=a(b)(e);f.append(c)}}function A(a){return a=a||"",a.match(/^[aeiou]/)?"an":"a"}function B(a){if(a){var b,d,e;if(C(a))b="root of the sentence",a=void 0;else{var f=c.getLabelObj(a);f?(d=f.long,e=f.style):(d="[]",e=""),b=a.string}return{token:a,string:b,label:d,style:e,article:A(d)}}}function C(a){return angular.equals(a,{})}var D,E,F,G=[],H=[];e.$watch("tokenId",i),k("head.id"),k("relation.label"),e.$on("$destroy",l)}}}]),angular.module("arethusa.relation").service("relation",["state","configurator","globalSettings","commons","_",function(a,b,c,d,e){function f(){b.getConfAndDelegate(u),b.getStickyConf(u,v),u.relationValues=u.conf.relations,g(),u.relations={},w=void 0}function g(){angular.forEach(u.relationValues.labels,h)}function h(a){var b=a.nested;b&&angular.forEach(b,function(b,c){b.parent=a,h(b)})}function i(a,b){b=angular.isDefined(b)?b:a.label;var c=b.split("_");a.prefix=c.shift()||"",a.suffix=c.join("_")}function j(a,b){var c,d,e;for(c in b){if(a===c)return b[c];if(d=b[c],d.nested&&(e=j(a,d.nested)))return e}}function k(a,b){var c=b.parent;return c&&(k(a,c),a.unshift(c)),a}function l(b,c,d,e){return e=e||angular.copy(c.ancestors),function(){i(c,d),c.ancestors=e,n()&&r(b,e),a.change(c.id,"relation.label",d)}}function m(a,b,c){var d=angular.copy(b.ancestors);return function(){b.ancestors=d,i(b,c),n()&&r(a,d)}}function n(){return c.isColorizer("relation")}function o(a,b,c){c.relation||(c.relation=u.relationTemplate()),c.relation.id=b,a[b]={string:c.string,relation:u.expandRelation(c.relation||"")}}function p(a,b,c){angular.forEach(a,function(a,d){var e=a.style,f=a.nested;if(e){var g=aU.flatten(aU.map(c,a)).join(" || ");b[g]=e}f&&p(f,b,c)})}function q(){var a=["short","long"],b={},c={header:a,maps:[{label:"Label",colors:b}]};return p(u.relationValues.labels,b,a),c}function r(b,c){var d=aU.last(c||u.relations[b].relation.ancestors)||{},e=d.style||{};a.addStyle(b,e)}function s(a){return e.last(t(a))}function t(a){return(a.relation||{}).ancestors||[]}var u=this;this.name="relation",this.canSearch=!0,c.addColorizer("relation");var v=["advancedMode","syntaxDescriptions"];this.currentLabels=function(){return arethusaUtil.inject({},a.selectedTokens,function(a,b,c){a[b]=u.relations[b]})},this.buildLabel=function(a,b){var c=[a.prefix,a.suffix],d=arethusaUtil.inject([],c,function(a,b){b&&a.push(b)}),e=d.join("_");return b||(a.label=e),e},this.prefixWithAncestors=function(a){return arethusaUtil.inject([],a.ancestors,function(a,b){a.push(b.short)}).join(" > ")||"---"},this.suffixOrPlaceholder=function(a){return a.suffix||"---"},this.usePrefix="prefix",this.useSuffix="suffix",this.defineAncestors=!0,this.initAncestors=function(a){var b=a.prefix,c=[];if(b){var d=j(b,u.relationValues.labels);d&&(c=k([],d),c.push(d))}a.ancestors=c},this.expandRelation=function(a){return i(a),u.initAncestors(a),a},this.relationTemplate=function(){return{prefix:"",suffix:"",label:"",ancestors:[]}},this.resetSearchedLabel=function(){u.searchedLabel=u.relationTemplate()},this.selectByLabel=function(b){var c=arethusaUtil.inject([],u.relations,function(a,c,d){d.relation.label===b&&a.push(c)});a.multiSelect(c)},this.buildLabelAndSearch=function(a){a=a||u.searchedLabel,u.buildLabel(a),u.selectByLabel(a.label)},this.resetMultiChanger=function(){this.multiChanger=u.relationTemplate()},this.multiChangePossible=function(){return""!==u.multiChanger.prefix&&a.hasSelections()},this.applyMultiChanger=function(){var b=angular.copy(u.multiChanger);delete b.label,a.doBatched(function(){angular.forEach(u.currentLabels(),function(a,c){var d=a.relation.ancestors;angular.extend(a.relation,b),u.changeState(a.relation,d)})})},this.changeState=function(b,c){var d=b.id,e=b.label,f=u.buildLabel(b,!!d);d&&a.change(d,"relation.label",f,l(d,b,e,c),m(d,b,f))},this.createInternalState=function(){return arethusaUtil.inject({},a.tokens,o)},this.canEdit=function(){return"editor"===u.mode},a.on("tokenAdded",function(a,b){o(u.relations,b.id,b)}),a.on("tokenRemoved",function(a,b){delete u.relations[b.id]});var w;this.colorMap=function(){return w||(w=q()),w},this.applyStyling=function(){angular.forEach(a.tokens,function(b,c){b.relation.label?r(c):a.unsetStyle(c)})},this.settings=[d.setting("Advanced Mode","advancedMode"),d.setting("Show Syntax Descriptions","syntaxDescriptions")],this.getLabelObj=s,this.init=function(){f(),u.relations=u.createInternalState(),u.resetSearchedLabel(),u.resetMultiChanger(),n()&&u.applyStyling()}}]),angular.module("arethusa.relation").run(["$templateCache",function(a){a.put("js/arethusa.relation/templates/context_menu.html",'<div label-selector obj="token.relation"></div>\n'),a.put("js/arethusa.relation/templates/label_selector.html",'<ul class="nested-dropdown">\n  <li class="first-item">{{ plugin.prefixWithAncestors(obj) }}\n    <ul\n      ng-if="showMenu"\n      class="top-menu"\n      nested-menu-collection\n      property="plugin.usePrefix"\n      current="obj"\n      ancestors="plugin.defineAncestors"\n      all="plugin.relationValues.labels"\n      empty-val="true">\n    </ul>\n  </li>\n</ul>\n<ul class="nested-dropdown" ng-if="plugin.relationValues.suffixes">\n  <li class="first-item">{{ plugin.suffixOrPlaceholder(obj) }}\n    <ul\n      ng-if="showMenu"\n      class="top-menu"\n      nested-menu-collection\n      property="plugin.useSuffix"\n      current="obj"\n      all="plugin.relationValues.suffixes"\n      empty-val="true">\n    </ul>\n  </li>\n</ul>\n\n'),a.put("js/arethusa.relation/templates/relation_multi_changer.html",'<div>\n  <label class="note">\n    <span translate="relation.changeAll"/>\n  </label>\n  <span\n    label-selector\n    obj="r.multiChanger">\n  </span>\n  <button\n    class="micro radius"\n    ng-disabled="! isPossible()"\n    ng-click="apply()">\n    <span translate="apply"/>\n  </button>\n</div>\n'),a.put("js/arethusa.relation/templates/search.html",'<div class="row">\n  <div class="small-12 columns">\n    <label>\n      <span translate="relation.searchByLabel"/>\n    <div\n      label-selector\n      obj="plugin.searchedLabel"\n      change="plugin.buildLabelAndSearch()">\n    </div>\n  </div>\n</div>\n\n')}]);
//# sourceMappingURL=arethusa.relation.min.map